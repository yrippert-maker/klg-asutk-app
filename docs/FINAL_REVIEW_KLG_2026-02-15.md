# –§–∏–Ω–∞–ª—å–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ: –ö–õ–ì –ê–°–£ –¢–ö

**–î–∞—Ç–∞:** 15 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–†–µ–≤–∏–∑–∏—è:** 3 (–ø–æ—Å–ª–µ –¥–≤—É—Ö –∏—Ç–µ—Ä–∞—Ü–∏–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)  
**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** github.com/yrippert-maker/klg-asutk-app  
**–ö–æ–º–º–∏—Ç—ã:** 4 (initial ‚Üí consolidation ‚Üí security fix ‚Üí missing files)

---

## –†–µ–∑—é–º–µ

–ü—Ä–æ–µ–∫—Ç –ø—Ä–æ—à—ë–ª —á–µ—Ä–µ–∑ –¥–≤–∞ —Ü–∏–∫–ª–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π. **–í—Å–µ 18 –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º** –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–≤—å—é –∞–¥—Ä–µ—Å–æ–≤–∞–Ω—ã. –ò–∑ –Ω–∏—Ö **17 –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**, **1 –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∞—è** (R-2).

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ | –°–µ–π—á–∞—Å |
|-----------|:-:|:-:|
| –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ? | ‚ùå 6+ ImportError | ‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ –Ω–∞ –º–µ—Å—Ç–µ |
| Backend (API, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞) | üü° | üü¢ |
| Frontend (React/Next.js) | üü° | üü¢ |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | üî¥ | üü¢ |
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¢–ó | üü¢ | üü¢ |

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (17 –∏–∑ 18)

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª | –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ |
|---|----------|------|-----------|
| 1 | `oidc.py` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç | `deps.py` –ø–µ—Ä–µ–ø–∏—Å–∞–Ω ‚Üí `security.py` | ‚úÖ |
| 2 | –î–≤–∞ –º–æ–¥—É–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | –ï–¥–∏–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ deps‚Üísecurity | ‚úÖ |
| 3 | Fallback –Ω–∞ admin –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ | –ë–µ–∑ —Ç–æ–∫–µ–Ω–∞ ‚Üí 401 Always | ‚úÖ |
| 4 | `rate_limit.py` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –°–æ–∑–¥–∞–Ω, TokenBucket –∞–ª–≥–æ—Ä–∏—Ç–º | ‚úÖ |
| 5 | `helpers.py` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –°–æ–∑–¥–∞–Ω, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π (audit, tenant, pagination) | ‚úÖ |
| 6 | `ws_manager.py` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –°–æ–∑–¥–∞–Ω, –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è + –¥–æ–º–µ–Ω-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | ‚úÖ |
| 7 | `risk_scheduler.py` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –°–æ–∑–¥–∞–Ω, APScheduler + –§–ì–ò–° sync | ‚úÖ |
| 8 | `email_service.py` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –°–æ–∑–¥–∞–Ω, SMTP + —à–∞–±–ª–æ–Ω—ã + stub | ‚úÖ |
| 9 | `request_logger.py` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –°–æ–∑–¥–∞–Ω, —Å X-Response-Time | ‚úÖ |
| 10 | AUTH_DEPENDENCY –Ω–µ –ø—Ä–∏–º–µ–Ω—è–ª—Å—è | –í—Å–µ —Ä–æ—É—Ç–µ—Ä—ã –∑–∞—â–∏—â–µ–Ω—ã | ‚úÖ |
| 11 | Path traversal –≤ attachments | `Path.resolve()` + startswith check | ‚úÖ |
| 12 | –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (attachments) | `is_authority` + `uploaded_by_user_id` | ‚úÖ |
| 13 | –î–µ—Ñ–æ–ª—Ç–Ω—ã–π SECRET_KEY | `${SECRET_KEY:?...}` ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | ‚úÖ |
| 14 | Keycloak –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –æ–¥–Ω–æ–π –ë–î | –û—Ç–¥–µ–ª—å–Ω—ã–π `keycloak-db` —Å–µ—Ä–≤–∏—Å | ‚úÖ |
| 15 | CSP: unsafe-eval + api.openai.com | –£–±—Ä–∞–Ω—ã; connect-src –≤–∫–ª—é—á–∞–µ—Ç api.anthropic.com | ‚úÖ |
| 16 | –¢–æ–∫–µ–Ω –≤ sessionStorage | –¢–æ–ª—å–∫–æ in-memory `_token` | ‚úÖ |
| R-1 | `setup_scheduler` –Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è –≤ lifespan | –í lifespan –ø–µ—Ä–µ–¥ `yield` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `setup_scheduler(app)` | ‚úÖ |

### üìù –ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–æ–µ (1)

**R-2: Deprecated `lib/api.ts` —É–¥–∞–ª—ë–Ω, –Ω–æ `Aircraft` –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è**

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Aircraft` –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ `api-client.ts` —Å `[key: string]: any` ‚Äî —Ç–∏–ø–∏–∑–∞—Ü–∏—è –≤—Å—ë –µ—â—ë —Å–ª–∞–±–∞—è. –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É, –Ω–æ —Å—Ç–æ–∏—Ç –∑–∞–º–µ–Ω–∏—Ç—å `any` –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∏–ø—ã –≤ –±—É–¥—É—â–µ–º.

---

## –ö–∞—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

Cursor —Å–æ–∑–¥–∞–ª —Ñ–∞–π–ª—ã –Ω–µ –∫–∞–∫ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏, –∞ –∫–∞–∫ **–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** —Å –¥–æ–º–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π:

| –§–∞–π–ª | –ö–∞—á–µ—Å—Ç–≤–æ | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|------|----------|------------|
| `helpers.py` | üü¢ –û—Ç–ª–∏—á–Ω–æ | `diff_changes`, tenant filtering, org caching |
| `ws_manager.py` | üü¢ –û—Ç–ª–∏—á–Ω–æ | Room-based + user/org routing, –¥–æ–º–µ–Ω-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ notify-—Ñ—É–Ω–∫—Ü–∏–∏ (AD, –¥–µ—Ñ–µ–∫—Ç—ã, AOG, LifeLimit) |
| `risk_scheduler.py` | üü¢ –û—Ç–ª–∏—á–Ω–æ | APScheduler 6—á + –§–ì–ò–° –†–≠–í–° –∞–≤—Ç–æ-sync 24—á, graceful degradation |
| `email_service.py` | üü¢ –û—Ç–ª–∏—á–Ω–æ | SMTP + stub, —à–∞–±–ª–æ–Ω—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∞–ª–µ—Ä—Ç–æ–≤, singleton |
| `request_logger.py` | üü¢ –•–æ—Ä–æ—à–æ | X-Response-Time header, skip health/metrics, –∞—É–¥–∏—Ç regulator-–¥–æ—Å—Ç—É–ø–∞ |
| `rate_limit.py` | üü¢ –•–æ—Ä–æ—à–æ | TokenBucket –∞–ª–≥–æ—Ä–∏—Ç–º –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ sliding window, skip health/docs |

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

```
–ó–∞–ø—Ä–æ—Å ‚Üí RateLimitMiddleware ‚Üí RequestLoggerMiddleware ‚Üí CORS
       ‚Üí AUTH_DEPENDENCY (deps.py ‚Üí security.py ‚Üí OIDC/Keycloak)
       ‚Üí –†–æ—É—Ç–µ—Ä (RBAC —á–µ—Ä–µ–∑ require_roles)
       ‚Üí –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ ‚Üí DB (RLS –ø–æ org_id)
       ‚Üí Audit trail (helpers.audit)
       ‚Üí WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (ws_manager)
       ‚Üí –û—Ç–≤–µ—Ç
```

–¶–µ–ø–æ—á–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: Rate limit ‚Üí Logging ‚Üí Auth ‚Üí RBAC ‚Üí RLS ‚Üí Audit ‚Äî –ø–æ–ª–Ω–∞—è.

---

## –û—Å—Ç–∞–≤—à–∏–µ—Å—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ)

1. **–¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞—Ç—å API-–∫–ª–∏–µ–Ω—Ç** ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å `PaginatedResponse<any>` –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã. –ù–µ —Å—Ä–æ—á–Ω–æ, –Ω–æ –ø–æ–≤—ã—Å–∏—Ç –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å frontend.
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å `storage_dir` / `INBOX_DATA_DIR`** ‚Äî `attachments.py` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `settings.INBOX_DATA_DIR`, `storage.py` ‚Äî `settings.storage_dir`. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±–∞ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –æ–¥–Ω—É –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é.
3. **–¢–µ—Å—Ç—ã** ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ `deps.py` (async `get_current_user` –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å mock-–∏ –≤ —Ç–µ—Å—Ç–∞—Ö).
4. **–í production —É–±—Ä–∞—Ç—å `ENABLE_DEV_AUTH`** ‚Äî –≤ `.env.example` –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —á—ë—Ç–∫–æ –ø–æ–º–µ—Ç–∏—Ç—å, —á—Ç–æ `ENABLE_DEV_AUTH=true` –¥–æ–ø—É—Å—Ç–∏–º –¢–û–õ–¨–ö–û –≤ development.

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç **–≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É –≤ dev-—Å—Ä–µ–¥–µ** –∏ –±–ª–∏–∑–æ–∫ –∫ production-ready –ø—Ä–æ—Ç–æ—Ç–∏–ø—É. –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –¢–ó ¬´–ö–õ–ì –ø–æ–¥ –ê–°–£ –¢–ö¬ª.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –≥–æ—Ç–æ–≤ –∫ demo/UAT.**
